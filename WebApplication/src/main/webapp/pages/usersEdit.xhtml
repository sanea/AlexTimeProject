<html xmlns="http://www.w3.org/1999/xhtml"
      xmlns:h="http://java.sun.com/jsf/html"
      xmlns:f="http://java.sun.com/jsf/core"
      xmlns:p="http://primefaces.org/ui"
      xmlns:ui="http://java.sun.com/jsf/facelets">
<h:body>
<ui:composition template="templates/template.xhtml">
<ui:define name="content">

<h2><h:outputText value="#{msg['users.edit.title']}"/></h2>
<h:form id="contentForm">
<p:commandButton icon="ui-icon-plus" update=":contentForm:addDialogContent"
                 actionListener="#{userEditMB.addNewUserListener}"
                 oncomplete="addUserDlg.show();" process="@this" title="#{msg['users.edit.add.new']}"/>
<p:dataTable var="user" value="#{userEditMB.userList}" id="userTable" editable="true" editMode="row">

<p:ajax event="rowEdit" listener="#{userEditMB.onEdit}" update=":messages"/>
<p:ajax event="rowEditCancel" listener="#{userEditMB.onCancel}" update=":messages"/>

<p:column headerText="#{msg['username']}" sortBy="#{user.username}">
    <p:cellEditor>
        <f:facet name="output">
            <h:outputText value="#{user.username}"/>
        </f:facet>
        <f:facet name="input">
            <h:outputText value="#{user.username}"/>
        </f:facet>
    </p:cellEditor>
</p:column>

<p:column headerText="#{msg['password']}" style="text-align: center;">
    <p:cellEditor>
        <f:facet name="output">
            <p:commandButton value="Change password" process="@this"
                             oncomplete="changePasswordDlg.show();"
                             update=":contentForm:changePasswordDialog"
                             disabled="#{user.deleted}">
                <f:setPropertyActionListener value="#{user}" target="#{userEditMB.selectedUser}"/>
            </p:commandButton>
        </f:facet>
        <f:facet name="input">
            <h:panelGroup/>
        </f:facet>
    </p:cellEditor>
</p:column>

<p:column headerText="#{msg['name.first']}" sortBy="#{user.firstName}">
    <p:cellEditor>
        <f:facet name="output">
            <h:outputText value="#{user.firstName}"/>
        </f:facet>
        <f:facet name="input">
            <p:inputText value="#{user.firstName}" styleClass="w100"/>
        </f:facet>
    </p:cellEditor>
</p:column>

<p:column headerText="#{msg['name.last']}" sortBy="#{user.lastName}">
    <p:cellEditor>
        <f:facet name="output">
            <h:outputText value="#{user.lastName}"/>
        </f:facet>
        <f:facet name="input">
            <p:inputText value="#{user.lastName}" styleClass="w100"/>
        </f:facet>
    </p:cellEditor>
</p:column>

<p:column headerText="#{msg['name.middle']}" sortBy="#{user.middleName}">
    <p:cellEditor>
        <f:facet name="output">
            <h:outputText value="#{user.middleName}"/>
        </f:facet>
        <f:facet name="input">
            <p:inputText value="#{user.middleName}" styleClass="w100"/>
        </f:facet>
    </p:cellEditor>
</p:column>

<p:column headerText="#{msg['phone']} 1" sortBy="#{user.phone1}">
    <p:cellEditor>
        <f:facet name="output">
            <h:outputText value="#{user.phone1}"/>
        </f:facet>
        <f:facet name="input">
            <p:inputMask value="#{user.phone1}" styleClass="w100" mask="+7(999) 999-9999"/>
        </f:facet>
    </p:cellEditor>
</p:column>

<p:column headerText="#{msg['phone']} 2" sortBy="#{user.phone2}">
    <p:cellEditor>
        <f:facet name="output">
            <h:outputText value="#{user.phone2}"/>
        </f:facet>
        <f:facet name="input">
            <p:inputMask value="#{user.phone2}" styleClass="w100" mask="+7(999) 999-9999"/>
        </f:facet>
    </p:cellEditor>
</p:column>

<p:column headerText="#{msg['email']}" sortBy="#{user.email}">
    <p:cellEditor>
        <f:facet name="output">
            <h:outputText value="#{user.email}"/>
        </f:facet>
        <f:facet name="input">
            <h:panelGrid cellspacing="0" cellpadding="0" columns="2" columnClasses="noBorder, noBorder">
                <p:inputText id="emailEdit" label="email"
                             validatorMessage="#{msg['users.edit.email.mess.invalid']}"
                             value="#{user.email}">
                    <f:validateRegex
                            pattern="(^$)|(^[_A-Za-z0-9-\+]+(\.[_A-Za-z0-9-]+)*@[A-Za-z0-9-]+(\.[A-Za-z0-9]+)*(\.[A-Za-z]{2,})$)"/>
                </p:inputText>
                <p:message for="emailEdit"/>
            </h:panelGrid>
        </f:facet>
    </p:cellEditor>
</p:column>

<p:column headerText="#{msg['country']}" sortBy="#{user.country}">
    <p:cellEditor>
        <f:facet name="output">
            <h:outputText value="#{user.country}"/>
        </f:facet>
        <f:facet name="input">
            <p:inputText value="#{user.country}" styleClass="w100"/>
        </f:facet>
    </p:cellEditor>
</p:column>

<p:column headerText="#{msg['city']}" sortBy="#{user.city}">
    <p:cellEditor>
        <f:facet name="output">
            <h:outputText value="#{user.city}"/>
        </f:facet>
        <f:facet name="input">
            <p:inputText value="#{user.city}" styleClass="w100"/>
        </f:facet>
    </p:cellEditor>
</p:column>

<p:column headerText="#{msg['address']}" sortBy="#{user.address}">
    <p:cellEditor>
        <f:facet name="output">
            <h:outputText value="#{user.address}"/>
        </f:facet>
        <f:facet name="input">
            <p:inputText value="#{user.address}" styleClass="w100"/>
        </f:facet>
    </p:cellEditor>
</p:column>

<p:column headerText="#{msg['enabled']}" sortBy="#{user.enabled}">
    <p:cellEditor>
        <f:facet name="output">
            <p:selectBooleanCheckbox value="#{user.enabled}"
                                     disabled="true"/>
        </f:facet>
        <f:facet name="input">
            <p:selectBooleanCheckbox value="#{user.enabled}"
                                     disabled="#{user.deleted}"/>
        </f:facet>
    </p:cellEditor>
</p:column>

<p:column headerText="#{msg['deleted']}" sortBy="#{user.deleted}">
    <p:cellEditor>
        <f:facet name="output">
            <p:selectBooleanCheckbox value="#{user.deleted}"
                                     disabled="true"/>
        </f:facet>
        <f:facet name="input">
            <p:selectBooleanCheckbox value="#{user.deleted}"
                                     disabled="#{not user.deleted}"/>
        </f:facet>
    </p:cellEditor>
</p:column>

<p:column headerText="#{msg['group']}" sortBy="#{user.groupMemberByUsername.groupByGroupId.groupName}">
    <p:cellEditor>
        <f:facet name="output">

            <p:commandLink value="#{user.groupMemberByUsername.groupByGroupId.groupName}"
                           process="@this" actionListener="#{userEditMB.assignListener}"
                           oncomplete="if (args &amp;&amp; args.showAssignDlg) { assignDlg.show(); }"
                           update=":contentForm:assignDialog" title="#{msg['users.edit.add']}"
                           rendered="#{user.groupMemberByUsername != null}"
                           disabled="#{user.deleted}">
                <f:attribute value="#{user}" name="user"/>
            </p:commandLink>
            <p:commandButton icon="ui-icon-plus"
                             process="@this" actionListener="#{userEditMB.assignListener}"
                             oncomplete="if (args &amp;&amp; args.showAssignDlg) { assignDlg.show(); }"
                             update=":contentForm:assignDialog" title="#{msg['users.edit.add.group']}"
                             rendered="#{user.groupMemberByUsername == null}"
                             disabled="#{user.deleted}">
                <f:attribute value="#{user}" name="user"/>
            </p:commandButton>

        </f:facet>
        <f:facet name="input">
            <h:outputText value="#{user.groupMemberByUsername.groupByGroupId.groupName}"/>
        </f:facet>
    </p:cellEditor>
</p:column>

<p:column>
    <p:rowEditor/>
</p:column>

<p:column>
    <h:panelGroup rendered="#{userEditMB.userDeletable[user.username]}">
        <p:commandButton icon="ui-icon-trash" process="@this" oncomplete="removeConfirmDlg.show();"
                         title="delete"
                         update=":contentForm:removeConfirmDialog">
            <f:setPropertyActionListener value="#{user}" target="#{userEditMB.selectedUser}"/>
        </p:commandButton>
    </h:panelGroup>
</p:column>

</p:dataTable>

<p:dialog id="addDialog" header="#{msg['users.edit.add']}" widgetVar="addUserDlg" modal="true" closable="true"
          closeOnEscape="true">
    <h:panelGrid id="addDialogContent" columns="3" cellpadding="2">
        <h:outputLabel for="userName" value="#{msg['name']}:"/>
        <p:inputText value="#{userEditMB.newUser.username}" id="userName" required="true"
                     requiredMessage="#{msg['name.mess.needed']}"
                     validatorMessage="#{msg['name.mess.inval.format']}">
            <f:validateRegex pattern="#{userEditMB.usernameRegexp}"/>
        </p:inputText>
        <p:message for="userName"/>

        <h:outputLabel for="password" value="#{msg['password']}:"/>
        <p:password id="password" value="#{userEditMB.newUser.password}" required="true"
                    requiredMessage="#{msg['users.edit.pass.mess.needed']}" feedback="true"
                    validatorMessage="#{msg['users.edit.pass.mess.length']}">
            <f:validateLength minimum="1" maximum="30"/>
        </p:password>
        <p:message for="password"/>

        <h:outputLabel for="firstName" value="#{msg['name.first']}:"/>
        <p:inputText id="firstName" value="#{userEditMB.newUser.firstName}"/>
        <h:panelGroup/>

        <h:outputLabel for="lastName" value="#{msg['name.last']}:"/>
        <p:inputText id="lastName" value="#{userEditMB.newUser.lastName}"/>
        <h:panelGroup/>

        <h:outputLabel for="middleName" value="#{msg['name.middle']}:"/>
        <p:inputText id="middleName" value="#{userEditMB.newUser.middleName}"/>
        <h:panelGroup/>

        <h:outputLabel for="phone1" value="#{msg['phone']} 1:"/>
        <p:inputMask id="phone1" value="#{userEditMB.newUser.phone1}" mask="+7(999) 999-9999"/>
        <h:panelGroup/>

        <h:outputLabel for="phone2" value="#{msg['phone']} 2:"/>
        <p:inputMask id="phone2" value="#{userEditMB.newUser.phone2}" mask="+7(999) 999-9999"/>
        <h:panelGroup/>

        <h:outputLabel for="email" value="#{msg['email']}:"/>
        <p:inputText id="email" label="email"
                     validatorMessage="#{msg['users.edit.email.mess.invalid']}"
                     value="#{userEditMB.newUser.email}" required="false">
            <f:validateRegex
                    pattern="(^$)|(^[_A-Za-z0-9-\+]+(\.[_A-Za-z0-9-]+)*@[A-Za-z0-9-]+(\.[A-Za-z0-9]+)*(\.[A-Za-z]{2,})$)"/>
        </p:inputText>
        <p:message for="email"/>


        <h:outputLabel for="userCountry" value="#{msg['country']}:"/>
        <p:inputText value="#{userEditMB.newUser.country}" id="userCountry"/>
        <h:panelGroup/>

        <h:outputLabel for="userCity" value="#{msg['city']}:"/>
        <p:inputText value="#{userEditMB.newUser.city}" id="userCity"/>
        <h:panelGroup/>

        <h:outputLabel for="userAddr" value="#{msg['address']}:"/>
        <p:inputText value="#{userEditMB.newUser.address}" id="userAddr"/>
        <h:panelGroup/>

        <h:outputLabel for="enabled" value="#{msg['enabled']}:"/>
        <p:selectBooleanCheckbox id="enabled" value="#{userEditMB.newUser.enabled}"/>
        <h:panelGroup/>

    </h:panelGrid>
    <f:facet name="footer">
        <p:commandButton value="#{msg['button.save']}" update=":contentForm:userTable :contentForm:addDialogContent"
                         oncomplete="if(args &amp;&amp; !args.validationFailed) addUserDlg.hide();"
                         action="#{userEditMB.addNewUser}" process=":contentForm:addDialog"/>
        <p:commandButton value="#{msg['button.cancel']}" oncomplete="addUserDlg.hide();" immediate="true"/>
    </f:facet>
</p:dialog>

<p:dialog id="removeConfirmDialog" header="#{msg['users.edit.remove']}" widgetVar="removeConfirmDlg" modal="true"
          closeOnEscape="true">

    <h:outputText value="#{msg['are.you.sure.remove']} '#{userEditMB.selectedUser.username}'?"/>

    <f:facet name="footer">
        <p:commandButton value="#{msg['button.yes']}" update=":contentForm:userTable"
                         oncomplete="removeConfirmDlg.hide()"
                         action="#{userEditMB.removeUser}" process="@this"/>
        <p:commandButton value="#{msg['button.no']}" onclick="removeConfirmDlg.hide()"/>
    </f:facet>
</p:dialog>

<p:dialog id="assignDialog" header="#{msg['users.edit.assign.group']}" widgetVar="assignDlg" modal="true"
          closable="true"
          closeOnEscape="true">
    <h:panelGrid id="assignDialogContent">
        <h:outputText value="#{msg['username']}: #{userEditMB.selectedUser.username}"/>
        <p:message for="groups"/>
        <p:selectOneRadio id="groups" value="#{userEditMB.selectedGroup}" layout="pageDirection"
                          required="true" requiredMessage="#{msg['users.edit.assign.group.select']}"
                          converter="#{groupConverter}">
            <f:selectItems value="#{userEditMB.groupList}" var="group"
                           itemLabel="#{group.groupName}" itemValue="#{group}"/>
        </p:selectOneRadio>
    </h:panelGrid>
    <f:facet name="footer">
        <p:commandButton value="#{msg['button.save']}" update=":contentForm:userTable :contentForm:assignDialogContent"
                         oncomplete="if(args &amp;&amp; !args.validationFailed) assignDlg.hide();"
                         action="#{userEditMB.assignUser}" process=":contentForm:assignDialog"/>
        <p:commandButton value="#{msg['button.cancel']}" oncomplete="assignDlg.hide();" update=":contentForm:userTable"
                         immediate="true"/>
    </f:facet>
</p:dialog>

<p:dialog id="changePasswordDialog" header="#{msg['users.edit.new.pass.title']}" widgetVar="changePasswordDlg"
          modal="true"
          closable="true" closeOnEscape="true">
    <h:outputText value="#{msg['users.edit.new.pass.mess']}"/>
    <h:panelGrid columns="2">
        <p:password id="newPassword" value="#{userEditMB.password}" styleClass="w100" required="true"
                    requiredMessage="#{msg['users.edit.pass.mess.needed']}" feedback="true"
                    validatorMessage="#{msg['users.edit.pass.mess.length']}">
            <f:validateLength minimum="1" maximum="30"/>
        </p:password>
        <p:message for="newPassword"/>
    </h:panelGrid>
    <f:facet name="footer">
        <p:commandButton value="#{msg['button.save']}" update=":contentForm:userTable :contentForm:changePasswordDialog"
                         oncomplete="if(args &amp;&amp; !args.validationFailed) changePasswordDlg.hide();"
                         action="#{userEditMB.changePassword}" process=":contentForm:changePasswordDialog"/>
        <p:commandButton id="cancelBtn" value="#{msg['button.cancel']}" oncomplete="changePasswordDlg.hide();"
                         update=":contentForm:userTable"
                         immediate="true"/>
    </f:facet>
</p:dialog>

</h:form>
</ui:define>
</ui:composition>
</h:body>
</html>